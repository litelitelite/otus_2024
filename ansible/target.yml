---
- name: Install target
  hosts: target
  become: true
  gather_facts: true
  tasks:
  
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install ISCSI target
      ansible.builtin.apt:
        name: targetcli-fb
        state: present

    - name: Create new partition
      community.general.parted:
        device: /dev/vdb
        number: 1
        state: present

    - name: Create a ext2 filesystem on /dev/vdb1
      ansible.builtin.command: mkfs.ext2 /dev/vdb1
      ignore_errors: true

    - name: Target settings
      ansible.builtin.command:
        "{{ item }}"
      with_items:
        - targetcli /backstores/block create disk01 /dev/vdb1
        - targetcli /iscsi create iqn.2024-05.ru.otus:storage.target00
        - targetcli /iscsi/iqn.2024-05.ru.otus:storage.target00/tpg1/luns create /backstores/block/disk01 lun=1
        - targetcli /iscsi/iqn.2024-05.ru.otus:storage.target00/tpg1/luns ls lun1
        - targetcli /iscsi/iqn.2024-05.ru.otus:storage.target00/tpg1/acls create iqn.2024-05.otus:ubuntu.{{ groups['initiator'][0] }}
        - targetcli /iscsi/iqn.2024-05.ru.otus:storage.target00/tpg1/acls create iqn.2024-05.otus:ubuntu.{{ groups['initiator'][1] }}
        - targetcli /iscsi/iqn.2024-05.ru.otus:storage.target00/tpg1/acls create iqn.2024-05.otus:ubuntu.{{ groups['initiator'][2] }}
        - targetcli /iscsi/iqn.2024-05.ru.otus:storage.target00/tpg1 set attribute authentication=0

      ignore_errors: true

